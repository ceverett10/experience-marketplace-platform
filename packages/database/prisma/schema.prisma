// Prisma Schema for Experience Marketplace Platform
// Multi-tenant SEO-optimized experience booking platform

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// PLATFORM SETTINGS
// ============================================================================

model PlatformSettings {
  id String @id @default(cuid())

  // Global Autonomous Controls
  allAutonomousProcessesPaused Boolean   @default(false) // Emergency stop for entire platform
  pausedAt                     DateTime? // When all processes were paused
  pausedBy                     String? // Admin identifier who paused
  pauseReason                  String? // Reason for global pause

  // Feature Flags
  enableSiteCreation        Boolean @default(true)
  enableContentGeneration   Boolean @default(true)
  enableGSCVerification     Boolean @default(true)
  enableContentOptimization Boolean @default(true)
  enableABTesting           Boolean @default(true)
  enableMicrosites          Boolean @default(true)

  // Microsite-specific pause control
  micrositeAutonomousProcessesPaused Boolean   @default(false)
  micrositePausedAt                  DateTime?
  micrositePausedBy                  String?
  micrositePauseReason               String?

  // Rate Limits
  maxTotalSites             Int @default(200) // Maximum total sites on platform
  maxSitesPerHour           Int @default(10) // Maximum sites created per hour
  maxContentPagesPerHour    Int @default(100)
  maxGSCRequestsPerHour     Int @default(200)
  maxOpportunityScansPerDay Int @default(50)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("platform_settings")
}

// ============================================================================
// SITE & BRAND MANAGEMENT
// ============================================================================

model Site {
  id          String  @id @default(cuid())
  slug        String  @unique
  name        String
  description String?

  // Brand Configuration
  brand   Brand?  @relation(fields: [brandId], references: [id])
  brandId String? @unique

  // Domain Configuration
  domains       Domain[]
  primaryDomain String?

  // Holibob Integration
  holibobPartnerId String
  holibobApiKey    String?

  // Site Settings
  status      SiteStatus @default(DRAFT)
  isAutomatic Boolean    @default(true) // Autonomous operation mode

  // Autonomous Process Controls
  autonomousProcessesPaused Boolean   @default(false) // Emergency stop for all autonomous operations
  pausedAt                  DateTime? // When processes were paused
  pausedBy                  String? // Admin identifier who paused
  pauseReason               String? // Reason for pausing

  // SEO Configuration
  seoConfig Json? // { titleTemplate, defaultDescription, keywords }

  // Homepage Configuration (AI-generated during site creation)
  // {
  //   hero: { title?, subtitle?, backgroundImage? },
  //   popularExperiences: { title?, subtitle?, destination?, categoryPath?, searchTerms? },
  //   destinations: [{ name, slug, icon }],
  //   testimonials?: [{ name, location, text, rating }]
  // }
  homepageConfig Json?

  // GSC Verification
  gscVerificationCode String? // Meta tag content for verification
  gscVerified         Boolean   @default(false)
  gscVerifiedAt       DateTime?
  gscPropertyUrl      String? // Full GSC property URL (sc-domain: or https://)
  gscLastSyncedAt     DateTime? // Last successful data sync

  // Relationships
  pages              Page[]
  content            Content[]
  bookings           Booking[]
  opportunities      SEOOpportunity[]
  abTests            ABTest[]
  metrics            PerformanceMetric[]
  jobs               Job[]
  manualTasks        ManualTask[]
  backlinks          Backlink[]
  linkOpportunities  LinkOpportunity[]
  linkableAssets     LinkableAsset[]
  errorLogs          ErrorLog[]
  seoIssues          SEOIssue[]
  analyticsSnapshots SiteAnalyticsSnapshot[]
  subscribers        Subscriber[]

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime?

  @@index([status])
  @@index([holibobPartnerId])
  @@index([gscVerified])
}

enum SiteStatus {
  DRAFT
  REVIEW
  DNS_PENDING
  GSC_VERIFICATION
  SSL_PENDING
  ACTIVE
  PAUSED
  ARCHIVED
}

model Brand {
  id      String  @id @default(cuid())
  name    String
  tagline String?

  // Visual Identity
  primaryColor   String @default("#6366f1")
  secondaryColor String @default("#8b5cf6")
  accentColor    String @default("#f59e0b")

  // Typography
  headingFont String @default("Inter")
  bodyFont    String @default("Inter")

  // Assets
  logoUrl     String?
  logoDarkUrl String? // Dark version of logo for transparent headers on hero images
  faviconUrl  String?
  ogImageUrl  String?

  // Social
  socialLinks Json? // { facebook, instagram, twitter, tiktok }

  // Generated by AI
  isAutoGenerated  Boolean @default(true)
  generationPrompt String?

  // Relations (Brand can belong to either Site OR MicrositeConfig, not both)
  site      Site?
  microsite MicrositeConfig?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Domain {
  id     String @id @default(cuid())
  domain String @unique

  // Domain Status
  status       DomainStatus @default(PENDING)
  verifiedAt   DateTime?
  sslEnabled   Boolean      @default(false)
  sslExpiresAt DateTime?

  // DNS Configuration
  cloudflareZoneId String?
  dnsConfigured    Boolean @default(false)

  // Registration Details
  registrar    String? // namecheap, cloudflare, etc.
  registeredAt DateTime?
  expiresAt    DateTime?
  autoRenew    Boolean   @default(true)

  // Cost Tracking
  registrationCost Decimal? @db.Decimal(10, 2)
  renewalCost      Decimal? @db.Decimal(10, 2)

  site   Site?   @relation(fields: [siteId], references: [id])
  siteId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([siteId])
}

enum DomainStatus {
  PENDING
  AVAILABLE // Domain checked and available for purchase
  NOT_AVAILABLE // Domain checked and not available (already registered elsewhere)
  REGISTERING
  DNS_PENDING
  SSL_PENDING
  ACTIVE
  EXPIRED
  FAILED
}

// ============================================================================
// CONTENT MANAGEMENT
// ============================================================================

model Page {
  id String @id @default(cuid())

  // Page Identity
  slug String
  type PageType

  // SEO
  title           String
  metaTitle       String?
  metaDescription String?
  canonicalUrl    String?

  // Content (current version)
  content   Content? @relation(fields: [contentId], references: [id])
  contentId String?  @unique

  // Page Settings
  status   PageStatus @default(DRAFT)
  noIndex  Boolean    @default(false)
  priority Float      @default(0.5) // Sitemap priority

  // Holibob Reference
  holibobProductId  String?
  holibobCategoryId String?
  holibobLocationId String?

  // Relationships (Page belongs to either Site OR MicrositeConfig)
  site        Site?            @relation(fields: [siteId], references: [id], onDelete: Cascade)
  siteId      String?
  microsite   MicrositeConfig? @relation(fields: [micrositeId], references: [id], onDelete: Cascade)
  micrositeId String?

  // A/B Testing
  abTestVariants ABTestVariant[]

  // SEO Issues
  seoIssues SEOIssue[]

  // Analytics
  pageViews Int @default(0)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime?

  @@unique([siteId, slug])
  @@unique([micrositeId, slug])
  @@index([siteId, type])
  @@index([micrositeId, type])
  @@index([status])
  @@index([holibobProductId])
}

enum PageType {
  HOMEPAGE
  LANDING
  CATEGORY
  PRODUCT
  BLOG
  FAQ
  ABOUT
  CONTACT
  LEGAL
}

enum PageStatus {
  DRAFT
  REVIEW
  PUBLISHED
  ARCHIVED
}

model Content {
  id String @id @default(cuid())

  // Content Body
  body       String        @db.Text
  bodyFormat ContentFormat @default(MARKDOWN)

  // Structured Data
  structuredData Json? // Schema.org JSON-LD

  // AI Generation Metadata
  isAiGenerated Boolean @default(true)
  aiModel       String? // claude-3-5-haiku, gpt-4o-mini, etc.
  aiPrompt      String? @db.Text

  // Quality Metrics
  qualityScore     Int? // 0-100 from AI Quality Gate
  readabilityScore Float?
  seoScore         Int?

  // Version Control
  version           Int       @default(1)
  previousVersion   Content?  @relation("ContentVersions", fields: [previousVersionId], references: [id])
  previousVersionId String?
  nextVersions      Content[] @relation("ContentVersions")

  // Relationships (Content belongs to either Site OR MicrositeConfig)
  page          Page?
  site          Site?            @relation(fields: [siteId], references: [id], onDelete: Cascade)
  siteId        String?
  microsite     MicrositeConfig? @relation(fields: [micrositeId], references: [id], onDelete: Cascade)
  micrositeId   String?
  opportunity   SEOOpportunity? @relation(fields: [opportunityId], references: [id])
  opportunityId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([siteId])
  @@index([micrositeId])
  @@index([qualityScore])
  @@index([isAiGenerated])
}

enum ContentFormat {
  MARKDOWN
  HTML
  JSON
}

// ============================================================================
// SEO & OPPORTUNITY MANAGEMENT
// ============================================================================

model SEOOpportunity {
  id String @id @default(cuid())

  // Keyword Data
  keyword      String
  searchVolume Int     @default(0)
  difficulty   Int     @default(50) // 0-100
  cpc          Decimal @default(0) @db.Decimal(10, 2)

  // Intent & Classification
  intent   SearchIntent
  niche    String
  location String? // Geographic targeting

  // Opportunity Scoring
  priorityScore  Int      @default(50) // 0-100 calculated score
  potentialValue Decimal? @db.Decimal(10, 2)

  // Status Tracking
  status OpportunityStatus @default(IDENTIFIED)

  // Relationships
  site    Site?     @relation(fields: [siteId], references: [id])
  siteId  String?
  content Content[]

  // Source Tracking
  source     String? // gsc, semrush, ahrefs, manual
  sourceData Json?

  // AI-generated explanation of why this is a good opportunity
  explanation String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([keyword, location])
  @@index([status])
  @@index([niche])
  @@index([priorityScore])
  @@index([siteId])
}

enum SearchIntent {
  INFORMATIONAL
  NAVIGATIONAL
  TRANSACTIONAL
  COMMERCIAL
}

enum OpportunityStatus {
  IDENTIFIED
  EVALUATED
  ASSIGNED
  CONTENT_CREATING
  CONTENT_REVIEW
  PUBLISHED
  MONITORING
  ARCHIVED
}

model PerformanceMetric {
  id String @id @default(cuid())

  // Time Period
  date DateTime @db.Date

  // GSC Metrics
  impressions Int   @default(0)
  clicks      Int   @default(0)
  ctr         Float @default(0)
  position    Float @default(0)

  // Query/Page Data
  query   String?
  pageUrl String?

  // Device & Country
  device  String? // DESKTOP, MOBILE, TABLET
  country String? // ISO country code

  // Relationships
  site   Site   @relation(fields: [siteId], references: [id], onDelete: Cascade)
  siteId String

  createdAt DateTime @default(now())

  @@unique([siteId, date, query, pageUrl, device, country])
  @@index([siteId, date])
  @@index([query])
}

model SiteAnalyticsSnapshot {
  id     String   @id @default(cuid())
  siteId String
  site   Site     @relation(fields: [siteId], references: [id], onDelete: Cascade)
  date   DateTime @db.Date

  // GA4 Traffic Metrics
  users              Int   @default(0)
  newUsers           Int   @default(0)
  sessions           Int   @default(0)
  pageviews          Int   @default(0)
  bounceRate         Float @default(0)
  avgSessionDuration Float @default(0)
  engagementRate     Float @default(0)

  // GA4 Traffic Sources (JSON for flexibility)
  trafficSources  Json? // [{ source, medium, users, sessions }]
  deviceBreakdown Json? // [{ device, users, sessions }]

  // Business Metrics (from existing Booking model)
  bookings Int     @default(0)
  revenue  Decimal @default(0) @db.Decimal(10, 2)

  // Metadata
  ga4Synced Boolean  @default(false)
  gscSynced Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([siteId, date])
  @@index([siteId, date])
  @@index([date])
  @@map("site_analytics_snapshots")
}

// ============================================================================
// A/B TESTING
// ============================================================================

model ABTest {
  id          String  @id @default(cuid())
  name        String
  description String?

  // Test Configuration
  type         ABTestType
  trafficSplit Json // { control: 50, variant_a: 50 }

  // Statistical Settings
  confidenceLevel Float @default(0.95)
  minimumSamples  Int   @default(100)

  // Status
  status    ABTestStatus @default(DRAFT)
  startedAt DateTime?
  endedAt   DateTime?

  // Results
  winningVariant String?

  // Relationships
  site     Site            @relation(fields: [siteId], references: [id], onDelete: Cascade)
  siteId   String
  variants ABTestVariant[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([siteId])
  @@index([status])
}

enum ABTestType {
  CONTENT
  LAYOUT
  CTA
  PRICING
  HEADLINE
}

enum ABTestStatus {
  DRAFT
  RUNNING
  PAUSED
  COMPLETED
  CANCELLED
}

model ABTestVariant {
  id   String @id @default(cuid())
  name String // control, variant_a, variant_b

  // Variant Configuration
  config Json // Variant-specific settings

  // Metrics
  impressions    Int   @default(0)
  conversions    Int   @default(0)
  conversionRate Float @default(0)

  // Multi-armed Bandit
  banditScore Float @default(0.5)

  // Relationships
  abTest   ABTest  @relation(fields: [abTestId], references: [id], onDelete: Cascade)
  abTestId String
  page     Page?   @relation(fields: [pageId], references: [id])
  pageId   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([abTestId])
}

// ============================================================================
// BOOKINGS & TRANSACTIONS
// ============================================================================

model Booking {
  id String @id @default(cuid())

  // Holibob Reference
  holibobBookingId String  @unique
  holibobBasketId  String?
  holibobProductId String? // Track which product was booked (for analytics)

  // Booking Status
  status BookingStatus @default(PENDING)

  // Financial
  totalAmount      Decimal  @db.Decimal(10, 2)
  currency         String   @default("GBP")
  commissionAmount Decimal? @db.Decimal(10, 2)
  commissionRate   Float?

  // Customer (minimal - Holibob handles PII)
  customerEmail     String?
  customerSessionId String?

  // Attribution
  utmSource   String?
  utmMedium   String?
  utmCampaign String?
  landingPage String?

  // Relationships
  site   Site   @relation(fields: [siteId], references: [id])
  siteId String

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?

  @@index([siteId])
  @@index([status])
  @@index([createdAt])
  @@index([siteId, holibobProductId, createdAt]) // For booking analytics queries
}

enum BookingStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
  REFUNDED
}

// ============================================================================
// BACKGROUND JOBS
// ============================================================================

model Job {
  id String @id @default(cuid())

  // Job Identity
  type  JobType
  queue String  @default("default")

  // Job Data
  payload Json
  result  Json?
  error   String? @db.Text

  // Execution
  status      JobStatus @default(PENDING)
  priority    Int       @default(5) // 1-10
  attempts    Int       @default(0)
  maxAttempts Int       @default(3)

  // Timing
  scheduledFor DateTime?
  startedAt    DateTime?
  completedAt  DateTime?

  // Relationships
  site   Site?   @relation(fields: [siteId], references: [id])
  siteId String?

  // Idempotency
  idempotencyKey String? @unique

  // Error logs
  errorLogs ErrorLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status, queue])
  @@index([scheduledFor])
  @@index([type])
  @@index([siteId])
  @@index([status, completedAt])
  @@index([status, updatedAt])
  @@index([type, createdAt])
  @@index([status, startedAt])
}

// ============================================================================
// ERROR LOG
// ============================================================================

model ErrorLog {
  id String @id @default(cuid())

  // Job reference
  jobId   String
  job     Job    @relation(fields: [jobId], references: [id], onDelete: Cascade)
  jobType String

  // Site context
  siteId String?
  site   Site?   @relation(fields: [siteId], references: [id])

  // Error details
  errorName     String
  errorMessage  String  @db.Text
  errorCategory String // EXTERNAL_API, DATABASE, CONFIGURATION, RATE_LIMIT, NETWORK, NOT_FOUND, UNKNOWN
  errorSeverity String  @default("MEDIUM") // LOW, MEDIUM, HIGH, CRITICAL
  stackTrace    String? @db.Text
  context       Json? // Arbitrary metadata from the job

  // Retry context
  attemptNumber Int     @default(1)
  retryable     Boolean @default(true)

  createdAt DateTime @default(now())

  @@index([jobId])
  @@index([jobType])
  @@index([siteId])
  @@index([errorCategory])
  @@index([createdAt])
  @@index([errorSeverity, createdAt])
  @@index([jobType, createdAt])
  @@index([errorCategory, createdAt])
}

// ============================================================================
// SEO ISSUE TRACKING
// ============================================================================

model SEOIssue {
  id String @id @default(cuid())

  // Site/Page reference
  siteId String
  site   Site    @relation(fields: [siteId], references: [id], onDelete: Cascade)
  pageId String?
  page   Page?   @relation(fields: [pageId], references: [id], onDelete: SetNull)

  // Issue details
  category    String // CONTENT, TECHNICAL, PERFORMANCE, COMPETITOR_GAP
  severity    String // LOW, MEDIUM, HIGH, CRITICAL
  title       String
  description String @db.Text

  // Recommended action
  recommendation  String @db.Text
  estimatedImpact String // e.g., "+5-10% traffic"

  // Status tracking
  status     String    @default("OPEN") // OPEN, IN_PROGRESS, RESOLVED, WONT_FIX
  resolvedAt DateTime?
  resolvedBy String?
  resolution String?   @db.Text

  // Auto-detected
  detectedAt DateTime @default(now())
  detectedBy String // Job type that found it

  // Metadata
  metadata Json? // Additional context (e.g., competitor URLs, CWV metrics)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([siteId])
  @@index([pageId])
  @@index([status])
  @@index([severity])
  @@index([category])
  @@index([detectedAt])
}

// ============================================================================
// MANUAL TASKS
// ============================================================================

model ManualTask {
  id String @id @default(cuid())

  // Task Details
  title       String
  description String?
  category    ManualTaskCategory
  priority    ManualTaskPriority @default(MEDIUM)
  status      ManualTaskStatus   @default(PENDING)

  // Context
  context Json? // Additional context data (e.g., domain name, site info)

  // Related Entities (optional)
  site   Site?   @relation(fields: [siteId], references: [id])
  siteId String?

  // Tracking
  dueDate     DateTime?
  completedAt DateTime?
  completedBy String?
  notes       String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([category])
  @@index([priority])
  @@map("manual_tasks")
}

enum ManualTaskCategory {
  DOMAIN_PURCHASE
  DNS_CONFIGURATION
  SSL_SETUP
  CONTENT_REVIEW
  SEO_OPTIMIZATION
  SITE_CONFIGURATION
  EXTERNAL_SERVICE
  OTHER
}

enum ManualTaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum ManualTaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
  BLOCKED
}

enum JobType {
  // Content Generation
  CONTENT_GENERATE
  CONTENT_OPTIMIZE
  CONTENT_REVIEW

  // SEO
  SEO_ANALYZE
  SEO_AUTO_OPTIMIZE // Auto-fix common SEO issues
  SEO_OPPORTUNITY_SCAN
  SEO_OPPORTUNITY_OPTIMIZE
  GSC_SYNC

  // Site Management
  SITE_CREATE
  SITE_DEPLOY
  DOMAIN_REGISTER
  DOMAIN_VERIFY
  SSL_PROVISION
  GSC_VERIFY
  GSC_SETUP

  // Analytics
  GA4_SETUP
  GA4_DAILY_SYNC
  REFRESH_ANALYTICS_VIEWS
  METRICS_AGGREGATE
  PERFORMANCE_REPORT
  MICROSITE_GSC_SYNC
  MICROSITE_ANALYTICS_SYNC

  // A/B Testing
  ABTEST_ANALYZE
  ABTEST_REBALANCE

  // Link Building
  LINK_OPPORTUNITY_SCAN
  LINK_BACKLINK_MONITOR
  LINK_OUTREACH_GENERATE
  LINK_ASSET_GENERATE

  // Microsite Management
  MICROSITE_CREATE
  MICROSITE_BRAND_GENERATE
  MICROSITE_CONTENT_GENERATE
  MICROSITE_PUBLISH
  MICROSITE_ARCHIVE
  MICROSITE_HEALTH_CHECK

  // Holibob Sync
  SUPPLIER_SYNC
  SUPPLIER_SYNC_INCREMENTAL
  PRODUCT_SYNC
  PRODUCT_SYNC_INCREMENTAL
}

enum JobStatus {
  PENDING
  SCHEDULED
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
  RETRYING
}

// ============================================================================
// LINK BUILDING & BACKLINK MANAGEMENT
// ============================================================================

model Backlink {
  id     String @id @default(cuid())
  siteId String
  site   Site   @relation(fields: [siteId], references: [id], onDelete: Cascade)

  sourceUrl    String // The page linking to us
  sourceDomain String // Domain of the source page
  targetUrl    String // Our page being linked to
  anchorText   String? // The clickable text of the link

  // Quality metrics
  domainAuthority Int   @default(0) // 0-100 DA score
  relevanceScore  Float @default(0) // 0-1 topical relevance
  spamScore       Float @default(0) // 0-1 spam probability

  // Link attributes
  isDoFollow Boolean @default(true)
  isActive   Boolean @default(true)

  // Tracking
  acquisitionMethod AcquisitionMethod @default(ORGANIC)
  firstSeenAt       DateTime          @default(now())
  lastCheckedAt     DateTime?
  lostAt            DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([siteId, sourceUrl, targetUrl])
  @@index([siteId])
  @@index([sourceDomain])
  @@index([isActive])
  @@index([domainAuthority])
}

enum AcquisitionMethod {
  ORGANIC
  GUEST_POST
  RESOURCE_PAGE
  BROKEN_LINK
  CONTENT_SYNDICATION
  MANUAL
}

model LinkOpportunity {
  id     String @id @default(cuid())
  siteId String
  site   Site   @relation(fields: [siteId], references: [id], onDelete: Cascade)

  targetDomain String // Domain to reach out to
  targetUrl    String // Specific page for the opportunity
  contactEmail String? // Contact email for outreach

  // Quality & scoring
  domainAuthority Int   @default(0)
  relevanceScore  Float @default(0)
  priorityScore   Float @default(0) // Computed from DA + relevance

  // Opportunity details
  opportunityType  LinkOpportunityType
  competitorUrl    String? // Competitor page that has a link from this source
  suggestedContent String? // What content to pitch or use

  // Outreach tracking
  status           LinkOpportunityStatus @default(IDENTIFIED)
  outreachTemplate String? // Generated outreach email (stored as text)
  outreachSentAt   DateTime?
  responseAt       DateTime?
  responseNotes    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([siteId, targetUrl])
  @@index([siteId])
  @@index([status])
  @@index([priorityScore])
  @@index([domainAuthority])
}

enum LinkOpportunityType {
  GUEST_POST
  RESOURCE_PAGE
  BROKEN_LINK
  COMPETITOR_BACKLINK
  CONTENT_MENTION
  DIRECTORY_LISTING
}

enum LinkOpportunityStatus {
  IDENTIFIED
  RESEARCHED
  OUTREACH_DRAFTED
  OUTREACH_SENT
  RESPONDED
  LINK_ACQUIRED
  REJECTED
  EXPIRED
}

model LinkableAsset {
  id     String @id @default(cuid())
  siteId String
  site   Site   @relation(fields: [siteId], references: [id], onDelete: Cascade)

  title     String
  slug      String
  assetType LinkableAssetType

  // Content
  content         String? // Generated markdown content
  metaTitle       String?
  metaDescription String?
  targetKeywords  String[] // Keywords this asset targets

  // Performance tracking
  backlinkCount Int @default(0)
  socialShares  Int @default(0)

  // Link to published page (if deployed)
  pageId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([siteId, slug])
  @@index([siteId])
  @@index([assetType])
}

enum LinkableAssetType {
  STATISTICS_ROUNDUP
  COMPREHENSIVE_GUIDE
  INFOGRAPHIC_DATA
  ORIGINAL_RESEARCH
}

// ============================================================================
// MICROSITE SYSTEM
// ============================================================================

// Supplier model - cached from Holibob API (discovered through products)
model Supplier {
  id                String @id @default(cuid())
  holibobSupplierId String @unique // Supplier ID from Holibob

  // Basic info
  name        String
  slug        String  @unique
  description String? @db.Text

  // Aggregated from products
  productCount Int      @default(0)
  cities       String[] // Cities where supplier operates
  categories   String[] // Categories of experiences offered
  rating       Float? // Average rating across all products
  reviewCount  Int      @default(0)

  // Price range (aggregated)
  priceRangeMin Decimal? @db.Decimal(10, 2)
  priceRangeMax Decimal? @db.Decimal(10, 2)
  priceCurrency String   @default("GBP")

  // Media
  logoUrl      String?
  heroImageUrl String?
  images       Json? // Array of image URLs

  // Relationships
  products  Product[]
  microsite MicrositeConfig?

  // Sync tracking
  lastSyncedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([productCount])
  @@index([rating])
  @@map("suppliers")
}

// Product model - cached from Holibob API
model Product {
  id               String @id @default(cuid())
  holibobProductId String @unique // Product ID from Holibob

  // Basic info
  slug             String  @unique
  title            String
  description      String? @db.Text
  shortDescription String?

  // Pricing
  priceFrom Decimal? @db.Decimal(10, 2)
  currency  String   @default("GBP")
  duration  String? // ISO 8601 duration or human-readable

  // Location
  city        String?
  country     String?
  coordinates Json? // { lat, lng }

  // Ratings
  rating      Float?
  reviewCount Int    @default(0)

  // Media
  primaryImageUrl String?
  images          Json? // Array of image URLs

  // Classification
  categories String[]
  tags       String[]

  // Supplier relationship
  supplier   Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  supplierId String

  // Optional: dedicated microsite (for premium products only)
  microsite MicrositeConfig?

  // Collections this product belongs to
  collections ProductCollection[]

  // Tracking
  bookingCount Int @default(0)
  pageViews    Int @default(0)

  // Flags
  isPremium Boolean @default(false) // Qualifies for dedicated microsite

  // Sync tracking
  lastSyncedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([supplierId])
  @@index([city])
  @@index([isPremium])
  @@index([rating])
  @@map("products")
}

// MicrositeConfig - configuration for a microsite subdomain
model MicrositeConfig {
  id String @id @default(cuid())

  // Domain info
  subdomain    String // e.g., "adventure-co"
  parentDomain String // e.g., "experiencess.com"
  fullDomain   String @unique // e.g., "adventure-co.experiencess.com" (computed)

  // Entity reference (either supplier OR product, not both)
  entityType MicrositeEntityType
  supplier   Supplier?           @relation(fields: [supplierId], references: [id])
  supplierId String?             @unique
  product    Product?            @relation(fields: [productId], references: [id])
  productId  String?             @unique

  // Brand (one-to-one, reuses existing Brand model)
  brand   Brand  @relation(fields: [brandId], references: [id])
  brandId String @unique

  // Site identity
  siteName String // e.g., "Adventure Co Tours"
  tagline  String?

  // SEO configuration
  seoConfig Json? // { titleTemplate, defaultDescription, keywords }

  // Homepage configuration (similar to Site.homepageConfig)
  homepageConfig Json?

  // Layout type determines homepage structure based on product count
  layoutType            MicrositeLayoutType @default(AUTO)
  cachedProductCount    Int                 @default(0)
  productCountUpdatedAt DateTime?

  // Content pages
  pages   Page[]
  content Content[]

  // Curated collections for discovery
  collections CuratedCollection[]

  // Status
  status MicrositeStatus @default(DRAFT)

  // Autonomous Process Controls (mirrors Site)
  autonomousProcessesPaused Boolean   @default(false)
  pausedAt                  DateTime?
  pausedBy                  String?
  pauseReason               String?

  // Analytics tracking
  pageViews         Int       @default(0)
  lastContentUpdate DateTime?

  // GSC tracking (uses parent domain property sc-domain:experiencess.com)
  gscLastSyncedAt DateTime? // Last successful GSC data sync

  // Relations
  analyticsSnapshots MicrositeAnalyticsSnapshot[]
  performanceMetrics MicrositePerformanceMetric[]
  subscribers        Subscriber[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([subdomain, parentDomain])
  @@index([status])
  @@index([entityType])
  @@index([parentDomain])
  @@map("microsite_configs")
}

enum MicrositeEntityType {
  SUPPLIER
  PRODUCT
}

enum MicrositeStatus {
  DRAFT
  GENERATING // Brand/content being generated
  REVIEW // Ready for review
  ACTIVE // Live and accessible
  PAUSED // Temporarily disabled
  ARCHIVED // Permanently disabled
}

enum MicrositeLayoutType {
  PRODUCT_SPOTLIGHT // 1 product - dedicated product landing page
  CATALOG // 2-50 products - compact grid, no empty sections
  MARKETPLACE // 50+ products - full marketplace layout (rarely used for microsites)
  AUTO // System determines based on product count (default)
}

// MicrositeAnalyticsSnapshot - Pre-aggregated daily GA4 + GSC metrics for microsites
model MicrositeAnalyticsSnapshot {
  id          String          @id @default(cuid())
  micrositeId String
  microsite   MicrositeConfig @relation(fields: [micrositeId], references: [id], onDelete: Cascade)
  date        DateTime        @db.Date

  // GA4 Traffic Metrics (from shared GA4 property)
  users              Int   @default(0)
  newUsers           Int   @default(0)
  sessions           Int   @default(0)
  pageviews          Int   @default(0)
  bounceRate         Float @default(0)
  avgSessionDuration Float @default(0)
  engagementRate     Float @default(0)

  // GA4 Traffic Sources (JSON for flexibility)
  trafficSources  Json? // [{ source, medium, users, sessions }]
  deviceBreakdown Json? // [{ device, users, sessions }]

  // GSC Search Metrics (aggregated from MicrositePerformanceMetric)
  totalClicks      Int   @default(0)
  totalImpressions Int   @default(0)
  avgCtr           Float @default(0)
  avgPosition      Float @default(0)

  // Metadata
  ga4Synced Boolean  @default(false)
  gscSynced Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([micrositeId, date])
  @@index([micrositeId, date])
  @@index([date])
  @@map("microsite_analytics_snapshots")
}

// MicrositePerformanceMetric - GSC search data for microsites
model MicrositePerformanceMetric {
  id String @id @default(cuid())

  // Time Period
  date DateTime @db.Date

  // GSC Metrics
  impressions Int   @default(0)
  clicks      Int   @default(0)
  ctr         Float @default(0)
  position    Float @default(0)

  // Query/Page Data
  query   String?
  pageUrl String?

  // Device & Country
  device  String? // DESKTOP, MOBILE, TABLET
  country String? // ISO country code

  // Relationship
  microsite   MicrositeConfig @relation(fields: [micrositeId], references: [id], onDelete: Cascade)
  micrositeId String

  createdAt DateTime @default(now())

  @@unique([micrositeId, date, query, pageUrl, device, country])
  @@index([micrositeId, date])
  @@index([query])
  @@map("microsite_performance_metrics")
}

// ============================================================================
// CURATED COLLECTIONS
// ============================================================================

// CuratedCollection - AI-generated groupings of products for discovery and SEO
model CuratedCollection {
  id String @id @default(cuid())

  // Identity
  name        String
  slug        String
  description String? @db.Text

  // Visual
  iconEmoji        String? // e.g., "‚ù§Ô∏è" for couples, "üèîÔ∏è" for adventure
  imageUrl         String?
  imageAttribution Json? // { photographer, photographerUrl, source }

  // Collection type determines grouping logic
  collectionType CollectionType

  // Targeting (optional filters)
  targetAudience String? // "couples", "families", "solo", "groups"
  seasonalMonths Int[] // [12, 1, 2] for winter, [6, 7, 8] for summer

  // Ownership - collections belong to a microsite
  microsite   MicrositeConfig @relation(fields: [micrositeId], references: [id], onDelete: Cascade)
  micrositeId String

  // Products in this collection
  products ProductCollection[]

  // Status & ordering
  isActive  Boolean @default(true)
  sortOrder Int     @default(0)

  // AI generation metadata
  isAiGenerated    Boolean @default(true)
  generationPrompt String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([micrositeId, slug])
  @@index([micrositeId])
  @@index([collectionType])
  @@index([isActive])
  @@map("curated_collections")
}

// ProductCollection - junction table for products in collections
model ProductCollection {
  id String @id @default(cuid())

  // Collection reference
  collection   CuratedCollection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  collectionId String

  // Product reference
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId String

  // Ordering within collection
  sortOrder Int @default(0)

  // Featured badge reason (e.g., "Top rated", "Best seller", "New")
  featuredReason String?

  createdAt DateTime @default(now())

  @@unique([collectionId, productId])
  @@index([collectionId])
  @@index([productId])
  @@map("product_collections")
}

enum CollectionType {
  AUDIENCE // couples, families, solo, groups
  SEASONAL // winter, summer, spring, fall
  THEMATIC // adventure, culture, food, relaxation
  CURATED // staff picks, highest rated, best sellers, new arrivals
}

// ============================================================================
// EMAIL SUBSCRIPTION & PRIZE DRAW
// ============================================================================

model Subscriber {
  id    String @id @default(cuid())
  email String @unique

  // Source tracking (which site/microsite captured this)
  siteId      String?
  site        Site?            @relation(fields: [siteId], references: [id])
  micrositeId String?
  microsite   MicrositeConfig? @relation(fields: [micrositeId], references: [id])
  domain      String // The exact domain where they subscribed

  // GDPR Consent Fields
  marketingConsent          Boolean   @default(false) // Explicit opt-in for ongoing marketing
  marketingConsentTimestamp DateTime? // When they gave marketing consent
  prizeDrawConsent          Boolean   @default(true) // Consent to enter prize draw
  prizeDrawConsentTimestamp DateTime  @default(now())

  // Consent audit trail
  ipAddress     String? // Hashed for privacy
  userAgent     String?
  consentSource String  @default("popup") // "popup", "footer", "checkout"

  // Prize draw tracking
  prizeDrawId     String?
  prizeDrawStatus PrizeDrawStatus @default(ENTERED)

  // Marketing status
  marketingStatus  MarketingStatus @default(PENDING)
  unsubscribedAt   DateTime?
  unsubscribeToken String          @unique @default(cuid()) // For one-click unsubscribe

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([siteId])
  @@index([micrositeId])
  @@index([domain])
  @@index([marketingConsent])
  @@index([prizeDrawStatus])
  @@index([createdAt])
  @@map("subscribers")
}

enum PrizeDrawStatus {
  ENTERED
  WINNER
  NOT_SELECTED
}

enum MarketingStatus {
  PENDING // Subscribed but not yet verified
  ACTIVE // Verified and receiving emails
  UNSUBSCRIBED // User opted out
  BOUNCED // Email bounced
}

model PrizeDraw {
  id          String  @id @default(cuid())
  name        String // "Win ¬£1,000 of experiences 2024"
  description String?

  prizeValue Decimal @db.Decimal(10, 2) // 1000.00
  currency   String  @default("GBP")

  // Draw timing
  startDate DateTime
  endDate   DateTime
  drawDate  DateTime? // When winner is selected

  // Status
  status String @default("ACTIVE") // DRAFT, ACTIVE, CLOSED, DRAWN, COMPLETED

  // Winner
  winnerId String?

  // Terms version
  termsVersion String @default("1.0")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("prize_draws")
}
