// Prisma Schema for Experience Marketplace Platform
// Multi-tenant SEO-optimized experience booking platform

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// PLATFORM SETTINGS
// ============================================================================

model PlatformSettings {
  id String @id @default(cuid())

  // Global Autonomous Controls
  allAutonomousProcessesPaused Boolean   @default(false) // Emergency stop for entire platform
  pausedAt                     DateTime? // When all processes were paused
  pausedBy                     String? // Admin identifier who paused
  pauseReason                  String? // Reason for global pause

  // Feature Flags
  enableSiteCreation        Boolean @default(true)
  enableContentGeneration   Boolean @default(true)
  enableGSCVerification     Boolean @default(true)
  enableContentOptimization Boolean @default(true)
  enableABTesting           Boolean @default(true)

  // Rate Limits
  maxTotalSites             Int @default(200) // Maximum total sites on platform
  maxSitesPerHour           Int @default(10) // Maximum sites created per hour
  maxContentPagesPerHour    Int @default(100)
  maxGSCRequestsPerHour     Int @default(200)
  maxOpportunityScansPerDay Int @default(50)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("platform_settings")
}

// ============================================================================
// SITE & BRAND MANAGEMENT
// ============================================================================

model Site {
  id          String  @id @default(cuid())
  slug        String  @unique
  name        String
  description String?

  // Brand Configuration
  brand   Brand?  @relation(fields: [brandId], references: [id])
  brandId String? @unique

  // Domain Configuration
  domains       Domain[]
  primaryDomain String?

  // Holibob Integration
  holibobPartnerId String
  holibobApiKey    String?

  // Site Settings
  status      SiteStatus @default(DRAFT)
  isAutomatic Boolean    @default(true) // Autonomous operation mode

  // Autonomous Process Controls
  autonomousProcessesPaused Boolean   @default(false) // Emergency stop for all autonomous operations
  pausedAt                  DateTime? // When processes were paused
  pausedBy                  String? // Admin identifier who paused
  pauseReason               String? // Reason for pausing

  // SEO Configuration
  seoConfig Json? // { titleTemplate, defaultDescription, keywords }

  // GSC Verification
  gscVerificationCode String? // Meta tag content for verification
  gscVerified         Boolean   @default(false)
  gscVerifiedAt       DateTime?
  gscPropertyUrl      String? // Full GSC property URL (sc-domain: or https://)
  gscLastSyncedAt     DateTime? // Last successful data sync

  // Relationships
  pages         Page[]
  content       Content[]
  bookings      Booking[]
  opportunities SEOOpportunity[]
  abTests       ABTest[]
  metrics       PerformanceMetric[]
  jobs          Job[]
  manualTasks   ManualTask[]

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime?

  @@index([status])
  @@index([holibobPartnerId])
  @@index([gscVerified])
}

enum SiteStatus {
  DRAFT
  REVIEW
  DNS_PENDING
  GSC_VERIFICATION
  SSL_PENDING
  ACTIVE
  PAUSED
  ARCHIVED
}

model Brand {
  id      String  @id @default(cuid())
  name    String
  tagline String?

  // Visual Identity
  primaryColor   String @default("#6366f1")
  secondaryColor String @default("#8b5cf6")
  accentColor    String @default("#f59e0b")

  // Typography
  headingFont String @default("Inter")
  bodyFont    String @default("Inter")

  // Assets
  logoUrl    String?
  faviconUrl String?
  ogImageUrl String?

  // Social
  socialLinks Json? // { facebook, instagram, twitter, tiktok }

  // Generated by AI
  isAutoGenerated  Boolean @default(true)
  generationPrompt String?

  site Site?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Domain {
  id     String @id @default(cuid())
  domain String @unique

  // Domain Status
  status       DomainStatus @default(PENDING)
  verifiedAt   DateTime?
  sslEnabled   Boolean      @default(false)
  sslExpiresAt DateTime?

  // DNS Configuration
  cloudflareZoneId String?
  dnsConfigured    Boolean @default(false)

  // Registration Details
  registrar    String? // namecheap, cloudflare, etc.
  registeredAt DateTime?
  expiresAt    DateTime?
  autoRenew    Boolean   @default(true)

  // Cost Tracking
  registrationCost Decimal? @db.Decimal(10, 2)
  renewalCost      Decimal? @db.Decimal(10, 2)

  site   Site?   @relation(fields: [siteId], references: [id])
  siteId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([siteId])
}

enum DomainStatus {
  PENDING
  AVAILABLE       // Domain checked and available for purchase
  NOT_AVAILABLE   // Domain checked and not available (already registered elsewhere)
  REGISTERING
  DNS_PENDING
  SSL_PENDING
  ACTIVE
  EXPIRED
  FAILED
}

// ============================================================================
// CONTENT MANAGEMENT
// ============================================================================

model Page {
  id String @id @default(cuid())

  // Page Identity
  slug String
  type PageType

  // SEO
  title           String
  metaTitle       String?
  metaDescription String?
  canonicalUrl    String?

  // Content (current version)
  content   Content? @relation(fields: [contentId], references: [id])
  contentId String?  @unique

  // Page Settings
  status   PageStatus @default(DRAFT)
  noIndex  Boolean    @default(false)
  priority Float      @default(0.5) // Sitemap priority

  // Holibob Reference
  holibobProductId  String?
  holibobCategoryId String?
  holibobLocationId String?

  // Relationships
  site   Site   @relation(fields: [siteId], references: [id], onDelete: Cascade)
  siteId String

  // A/B Testing
  abTestVariants ABTestVariant[]

  // Analytics
  pageViews Int @default(0)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime?

  @@unique([siteId, slug])
  @@index([siteId, type])
  @@index([status])
  @@index([holibobProductId])
}

enum PageType {
  HOMEPAGE
  LANDING
  CATEGORY
  PRODUCT
  BLOG
  FAQ
  ABOUT
  CONTACT
  LEGAL
}

enum PageStatus {
  DRAFT
  REVIEW
  PUBLISHED
  ARCHIVED
}

model Content {
  id String @id @default(cuid())

  // Content Body
  body       String        @db.Text
  bodyFormat ContentFormat @default(MARKDOWN)

  // Structured Data
  structuredData Json? // Schema.org JSON-LD

  // AI Generation Metadata
  isAiGenerated Boolean @default(true)
  aiModel       String? // claude-3-5-haiku, gpt-4o-mini, etc.
  aiPrompt      String? @db.Text

  // Quality Metrics
  qualityScore     Int? // 0-100 from AI Quality Gate
  readabilityScore Float?
  seoScore         Int?

  // Version Control
  version           Int       @default(1)
  previousVersion   Content?  @relation("ContentVersions", fields: [previousVersionId], references: [id])
  previousVersionId String?
  nextVersions      Content[] @relation("ContentVersions")

  // Relationships
  page          Page?
  site          Site            @relation(fields: [siteId], references: [id], onDelete: Cascade)
  siteId        String
  opportunity   SEOOpportunity? @relation(fields: [opportunityId], references: [id])
  opportunityId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([siteId])
  @@index([qualityScore])
  @@index([isAiGenerated])
}

enum ContentFormat {
  MARKDOWN
  HTML
  JSON
}

// ============================================================================
// SEO & OPPORTUNITY MANAGEMENT
// ============================================================================

model SEOOpportunity {
  id String @id @default(cuid())

  // Keyword Data
  keyword      String
  searchVolume Int     @default(0)
  difficulty   Int     @default(50) // 0-100
  cpc          Decimal @default(0) @db.Decimal(10, 2)

  // Intent & Classification
  intent   SearchIntent
  niche    String
  location String? // Geographic targeting

  // Opportunity Scoring
  priorityScore  Int      @default(50) // 0-100 calculated score
  potentialValue Decimal? @db.Decimal(10, 2)

  // Status Tracking
  status OpportunityStatus @default(IDENTIFIED)

  // Relationships
  site    Site?     @relation(fields: [siteId], references: [id])
  siteId  String?
  content Content[]

  // Source Tracking
  source     String? // gsc, semrush, ahrefs, manual
  sourceData Json?

  // AI-generated explanation of why this is a good opportunity
  explanation String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([keyword, location])
  @@index([status])
  @@index([niche])
  @@index([priorityScore])
  @@index([siteId])
}

enum SearchIntent {
  INFORMATIONAL
  NAVIGATIONAL
  TRANSACTIONAL
  COMMERCIAL
}

enum OpportunityStatus {
  IDENTIFIED
  EVALUATED
  ASSIGNED
  CONTENT_CREATING
  CONTENT_REVIEW
  PUBLISHED
  MONITORING
  ARCHIVED
}

model PerformanceMetric {
  id String @id @default(cuid())

  // Time Period
  date DateTime @db.Date

  // GSC Metrics
  impressions Int   @default(0)
  clicks      Int   @default(0)
  ctr         Float @default(0)
  position    Float @default(0)

  // Query/Page Data
  query   String?
  pageUrl String?

  // Device & Country
  device  String? // DESKTOP, MOBILE, TABLET
  country String? // ISO country code

  // Relationships
  site   Site   @relation(fields: [siteId], references: [id], onDelete: Cascade)
  siteId String

  createdAt DateTime @default(now())

  @@unique([siteId, date, query, pageUrl, device, country])
  @@index([siteId, date])
  @@index([query])
}

// ============================================================================
// A/B TESTING
// ============================================================================

model ABTest {
  id          String  @id @default(cuid())
  name        String
  description String?

  // Test Configuration
  type         ABTestType
  trafficSplit Json // { control: 50, variant_a: 50 }

  // Statistical Settings
  confidenceLevel Float @default(0.95)
  minimumSamples  Int   @default(100)

  // Status
  status    ABTestStatus @default(DRAFT)
  startedAt DateTime?
  endedAt   DateTime?

  // Results
  winningVariant String?

  // Relationships
  site     Site            @relation(fields: [siteId], references: [id], onDelete: Cascade)
  siteId   String
  variants ABTestVariant[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([siteId])
  @@index([status])
}

enum ABTestType {
  CONTENT
  LAYOUT
  CTA
  PRICING
  HEADLINE
}

enum ABTestStatus {
  DRAFT
  RUNNING
  PAUSED
  COMPLETED
  CANCELLED
}

model ABTestVariant {
  id   String @id @default(cuid())
  name String // control, variant_a, variant_b

  // Variant Configuration
  config Json // Variant-specific settings

  // Metrics
  impressions    Int   @default(0)
  conversions    Int   @default(0)
  conversionRate Float @default(0)

  // Multi-armed Bandit
  banditScore Float @default(0.5)

  // Relationships
  abTest   ABTest  @relation(fields: [abTestId], references: [id], onDelete: Cascade)
  abTestId String
  page     Page?   @relation(fields: [pageId], references: [id])
  pageId   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([abTestId])
}

// ============================================================================
// BOOKINGS & TRANSACTIONS
// ============================================================================

model Booking {
  id String @id @default(cuid())

  // Holibob Reference
  holibobBookingId String  @unique
  holibobBasketId  String?

  // Booking Status
  status BookingStatus @default(PENDING)

  // Financial
  totalAmount      Decimal  @db.Decimal(10, 2)
  currency         String   @default("GBP")
  commissionAmount Decimal? @db.Decimal(10, 2)
  commissionRate   Float?

  // Customer (minimal - Holibob handles PII)
  customerEmail     String?
  customerSessionId String?

  // Attribution
  utmSource   String?
  utmMedium   String?
  utmCampaign String?
  landingPage String?

  // Relationships
  site   Site   @relation(fields: [siteId], references: [id])
  siteId String

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?

  @@index([siteId])
  @@index([status])
  @@index([createdAt])
}

enum BookingStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
  REFUNDED
}

// ============================================================================
// BACKGROUND JOBS
// ============================================================================

model Job {
  id String @id @default(cuid())

  // Job Identity
  type  JobType
  queue String  @default("default")

  // Job Data
  payload Json
  result  Json?
  error   String? @db.Text

  // Execution
  status      JobStatus @default(PENDING)
  priority    Int       @default(5) // 1-10
  attempts    Int       @default(0)
  maxAttempts Int       @default(3)

  // Timing
  scheduledFor DateTime?
  startedAt    DateTime?
  completedAt  DateTime?

  // Relationships
  site   Site?   @relation(fields: [siteId], references: [id])
  siteId String?

  // Idempotency
  idempotencyKey String? @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status, queue])
  @@index([scheduledFor])
  @@index([type])
  @@index([siteId])
}

// ============================================================================
// MANUAL TASKS
// ============================================================================

model ManualTask {
  id String @id @default(cuid())

  // Task Details
  title       String
  description String?
  category    ManualTaskCategory
  priority    ManualTaskPriority @default(MEDIUM)
  status      ManualTaskStatus   @default(PENDING)

  // Context
  context Json? // Additional context data (e.g., domain name, site info)

  // Related Entities (optional)
  site   Site?   @relation(fields: [siteId], references: [id])
  siteId String?

  // Tracking
  dueDate     DateTime?
  completedAt DateTime?
  completedBy String?
  notes       String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([category])
  @@index([priority])
  @@map("manual_tasks")
}

enum ManualTaskCategory {
  DOMAIN_PURCHASE
  DNS_CONFIGURATION
  SSL_SETUP
  CONTENT_REVIEW
  SEO_OPTIMIZATION
  SITE_CONFIGURATION
  EXTERNAL_SERVICE
  OTHER
}

enum ManualTaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum ManualTaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
  BLOCKED
}

enum JobType {
  // Content Generation
  CONTENT_GENERATE
  CONTENT_OPTIMIZE
  CONTENT_REVIEW

  // SEO
  SEO_ANALYZE
  SEO_OPPORTUNITY_SCAN
  GSC_SYNC

  // Site Management
  SITE_CREATE
  SITE_DEPLOY
  DOMAIN_REGISTER
  DOMAIN_VERIFY
  SSL_PROVISION
  GSC_VERIFY
  GSC_SETUP

  // Analytics
  METRICS_AGGREGATE
  PERFORMANCE_REPORT

  // A/B Testing
  ABTEST_ANALYZE
  ABTEST_REBALANCE
}

enum JobStatus {
  PENDING
  SCHEDULED
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
  RETRYING
}
